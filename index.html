<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Spyne Outsource Dashboard</title>
  <link rel="icon" href="https://spyne-prod-ai.s3.us-east-1.amazonaws.com/ai-dataset/2025/favicon.ico" type="image/x-icon">
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #f4f7fa; margin: 0; padding: 20px; }
    .section { background: #fff; border: 1px solid #ccc; border-radius: 4px; padding: 15px; margin-bottom: 20px; }
    h2 { text-align: center; margin-top: 0; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 15px; }
    th, td { padding: 8px; border: 1px solid #ddd; text-align: center; }
    th { background: #eee; }
    #dailyChart { max-width: 100%; height: 300px; }
  </style>
</head>
<body>

  <div class="section"><h2>Spyne Outsource</h2></div>

  <div class="section">
    <h2>Daily Count Desc Bar (Current Month)</h2>
    <canvas id="dailyChart"></canvas>
    <div id="daily-summary-table"></div>
  </div>

  <div class="section">
    <h2>Active User</h2>
    <div id="live-user"></div>
  </div>

  <div class="section">
    <h2>User Data Date‑wise (Editor = Email, Images = Total)</h2>
    <div id="user-data"></div>
  </div>

  <script>
    const dailyDataURL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQkSnj-ldXkXXW21Jg2NIHO4b5B_KPHAJwy3T8_1L0-mPdGu_wrMC43nJb7bcAxXD7-xhNy3pqEZm18/pub?gid=585003148&single=true&output=csv';
    const liveUserURL  = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQkSnj-ldXkXXW21Jg2NIHO4b5B_KPHAJwy3T8_1L0-mPdGu_wrMC43nJb7bcAxXD7-xhNy3pqEZm18/pub?gid=1885524675&single=true&output=csv';

    function renderTable(elId, data) {
      const cols = Object.keys(data[0]);
      const header = `<thead><tr>${cols.map(c => `<th>${c}</th>`).join('')}</tr></thead>`;
      const body = `<tbody>${data.map(row => `<tr>${cols.map(c => `<td>${row[c]}</td>`).join('')}</tr>`).join('')}</tbody>`;
      document.getElementById(elId).innerHTML = `<table>${header}${body}</table>`;
    }

    // === Load Active Users ===
    Papa.parse(liveUserURL, {
      download: true, header: true, skipEmptyLines: true,
      complete: res => {
        if (!res.data.length) return;
        renderTable('live-user', res.data);
      }
    });

    // === Load Daily + Pivot Data (filtered to current month) ===
    Papa.parse(dailyDataURL, {
      download: true, header: true, skipEmptyLines: true,
      complete: res => {
        const raw = res.data;
        if (!raw.length) return;

        const today = new Date();
        const curM = today.getMonth(); // 0–11 :contentReference[oaicite:6]{index=6}
        const curY = today.getFullYear();

        // Filter current-month rows
        const filtered = raw.filter(r => {
          const dt = new Date(r.Date);
          return dt.getMonth() === curM && dt.getFullYear() === curY;
        });

        // Aggregate images per day
        const totalsByDate = {};
        filtered.forEach(r => {
          const d = r.Date;
          totalsByDate[d] = (totalsByDate[d] || 0) + (+r.Images || 0);
        });

        const dates = Object.keys(totalsByDate).sort();
        const counts = dates.map(d => totalsByDate[d]);

        // Render Chart.js bar chart
        new Chart(document.getElementById('dailyChart').getContext('2d'), {
          type: 'bar',
          data: {
            labels: dates,
            datasets: [{ label: 'Images per Day', data: counts, backgroundColor: '#4caf50' }]
          },
          options: {
            scales: {
              x: { ticks: { autoSkip: false, maxRotation: 45, minRotation: 45 } }
            },
            plugins: { legend: { display: false } }
          }
        });

        // Summary table
        const rows = dates.map(d => ({ Date: d, 'Total Images': totalsByDate[d].toString() }));
        renderTable('daily-summary-table', rows);

        // User pivot with Images totals
        const emails = [...new Set(filtered.map(r => r.Editor))];
        const emailTotals = {};
        emails.forEach(e => {
          emailTotals[e] = filtered.filter(r => r.Editor === e)
                                   .reduce((s, r) => s + (+r.Images || 0), 0);
        });

        const headerHTML = `<th>Email</th><th>Images</th>` + dates.map(d => `<th>${d}</th>`).join('');
        const bodyHTML = emails.map(e => {
          return `<tr><td>${e}</td><td>${emailTotals[e]}</td>` +
            dates.map(d => {
              const rec = filtered.find(r => r.Editor === e && r.Date === d);
              return `<td>${rec ? rec.Images : 0}</td>`;
            }).join('') + `</tr>`;
        }).join('');

        document.getElementById('user-data').innerHTML =
          `<table><thead><tr>${headerHTML}</tr></thead><tbody>${bodyHTML}</tbody></table>`;
      }
    });
  </script>
</body>
</html>
