<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Spyne Outsource Dashboard</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0; padding: 20px;
      background: #f4f7fa;
    }
    .section {
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 15px;
      margin-bottom: 20px;
    }
    h2 {
      text-align: center;
      margin-top: 0;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }
    th, td {
      padding: 8px; border: 1px solid #ddd;
      text-align: center;
    }
    th {
      background: #eee;
    }
    .bar-container {
      display: flex;
      align-items: flex-end;
      justify-content: space-around;
      height: 200px;
      border-left: 1px solid #333;
      border-bottom: 1px solid #333;
      padding-bottom: 10px;
    }
    .bar-wrapper {
      flex: 1;
      margin: 0 4px;
    }
    .bar {
      background: #4caf50;
      color: #fff;
      font-size: 12px;
      border-radius: 2px 2px 0 0;
      text-align: center;
    }
    .bar-label {
      margin-top: 4px;
      font-size: 12px;
      color: #333;
      text-align: center;
    }
  </style>
</head>
<body>
  <link rel="icon" href="https://spyne-prod-ai.s3.us-east-1.amazonaws.com/ai-dataset/2025/favicon.ico" type="image/x-icon">

  <div class="section" id="header">
    <h2>Spyne Outsource</h2>
  </div>

  <div class="section" id="dailyCountBar">
    <h2>Daily Count Desc Bar</h2>
    <div id="daily-summary-table"></div>
    <div id="daily-bar-chart" class="bar-container"></div>
  </div>

  <div class="section" id="activeUser">
    <h2>Active User</h2>
    <div id="live-user"></div>
  </div>

  <div class="section" id="userData">
    <h2>User Data Dateâ€‘wise (Editor = Email, Images = Total)</h2>
    <div id="user-data"></div>
  </div>

  <script>
    const dailyDataURL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQkSnj-ldXkXXW21Jg2NIHO4b5nJb7bcAxXD7-xhNy3pqEZm18/pub?gid=585003148&single=true&output=csv';
    const liveUserURL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQkSnj-ldXkXXW21Jg2NIHO4b5nJb7bcAxXD7-xhNy3pqEZm18/pub?gid=1885524675&single=true&output=csv';

    // Active Users Table
    fetch(liveUserURL)
      .then(res => res.text())
      .then(csv => Papa.parse(csv, { header: true, skipEmptyLines: true, complete: res => {
        const data = res.data;
        if (!data.length) return;
        const cols = Object.keys(data[0]);
        let html = '<table><thead><tr>' +
          cols.map(c => `<th>${c}</th>`).join('') +
          '</tr></thead><tbody>';
        data.forEach(row => {
          html += '<tr>' + cols.map(c => `<td>${row[c]}</td>`).join('') + '</tr>';
        });
        html += '</tbody></table>';
        document.getElementById('live-user').innerHTML = html;
      }}));

    // Daily Count Aggregation + Chart
    fetch(dailyDataURL)
      .then(res => res.text())
      .then(csv => Papa.parse(csv, { header: true, skipEmptyLines: true, complete: res => {
        const raw = res.data;
        const totalsByDate = raw.reduce((acc, d) => {
          acc[d.date] = (acc[d.date] || 0) + (+d.count || 0);
          return acc;
        }, {});
        const dates = Object.keys(totalsByDate).sort();

        // Table of totals
        let tbl = '<table><thead><tr><th>Date</th><th>Total Count</th></tr></thead><tbody>';
        dates.forEach(dt => {
          tbl += `<tr><td>${dt}</td><td>${totalsByDate[dt]}</td></tr>`;
        });
        tbl += '</tbody></table>';
        document.getElementById('daily-summary-table').innerHTML = tbl;

        // Bar chart
        const max = Math.max(...Object.values(totalsByDate));
        const container = document.getElementById('daily-bar-chart');
        container.innerHTML = '';
        dates.forEach(dt => {
          const val = totalsByDate[dt];
          const pct = max ? (val / max) : 0;
          const wrapper = document.createElement('div');
          wrapper.className = 'bar-wrapper';
          wrapper.innerHTML = `
            <div class="bar" style="height:${pct * 100}%">${val}</div>
            <div class="bar-label">${dt}</div>`;
          container.appendChild(wrapper);
        });
      }}));

    // User Data Pivot with Images Column
    fetch(dailyDataURL)
      .then(res => res.text())
      .then(csv => Papa.parse(csv, { header: true, skipEmptyLines: true, complete: res => {
        const data = res.data;
        if (!data.length) return;
        const emails = [...new Set(data.map(d => d.email))];
        const dates = [...new Set(data.map(d => d.date))].sort();

        // Compute total images per email
        const emailImages = emails.reduce((acc, email) => {
          acc[email] = data
            .filter(d => d.email === email)
            .reduce((sum, d) => sum + (+d.count || 0), 0);
          return acc;
        }, {});

        let html = '<table><thead><tr><th>Email</th><th>Images</th>' +
          dates.map(d => `<th>${d}</th>`).join('') +
          '</tr></thead><tbody>';
        emails.forEach(email => {
          html += `<tr><td>${email}</td><td>${emailImages[email]}</td>`;
          dates.forEach(dt => {
            const rec = data.find(d => d.email === email && d.date === dt);
            html += `<td>${rec ? rec.count : 0}</td>`;
          });
          html += '</tr>';
        });
        html += '</tbody></table>';
        document.getElementById('user-data').innerHTML = html;
      }}));
  </script>
</body>
</html>
