<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Spyne Outsource Dashboard</title>
  <link rel="icon" href="https://spyne-prod-ai.s3.us-east-1.amazonaws.com/ai-dataset/2025/logo/Spyne-outsource.png" type="image/x-icon">
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #fff; margin: 0; padding: 20px; }
    .chart-container { width: 100%; height: 66vh; }
    .section { background: #fff; border: 1px solid #ccc; border-radius: 4px; padding: 15px; margin-bottom: 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th, td { padding: 8px; border: 1px solid #ddd; text-align: center; }
    th { background: #eee; }
  </style>
</head>
<body>
  <div class="section">
    <h2>Spyne Outsource</h2>
  </div>

  <div class="section">
    <h2>Daily Count Desc Bar (Current Month)</h2>
    <div class="chart-container">
      <canvas id="dailyChart"></canvas>
    </div>
    <div id="daily-summary-table"></div>
  </div>

  <div class="section">
    <h2>Active User</h2>
    <div id="live-user"></div>
  </div>

  <script>
    const dailyDataURL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQkSnj-ldXkXXW21Jg2NIHO4b5B_KPHAJwy3T8_1L0-mPdGu_wrMC43nJb7bcAxXD7-xhNy3pqEZm18/pub?gid=585003148&single=true&output=csv';
    const liveUserURL  = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQkSnj-ldXkXXW21Jg2NIHO4b5B_KPHAJwy3T8_1L0-mPdGu_wrMC43nJb7bcAxXD7-xhNy3pqEZm18/pub?gid=1885524675&single=true&output=csv';

    function renderTable(elId, data) {
      const cols = Object.keys(data[0]);
      const header = `<thead><tr>${cols.map(c => `<th>${c}</th>`).join('')}</tr></thead>`;
      const body = `<tbody>${data.map(row => `<tr>${cols.map(c => `<td>${row[c]}</td>`).join('')}</tr>`).join('')}</tbody>`;
      document.getElementById(elId).innerHTML = `<table>${header}${body}</table>`;
    }

    Papa.parse(liveUserURL, {
      download: true, header: true, skipEmptyLines: true,
      complete: res => {
        if (res.data.length) renderTable('live-user', res.data);
      }
    });

    Papa.parse(dailyDataURL, {
      download: true, header: true, skipEmptyLines: true,
      complete: ({ data }) => {
        const today = new Date();
        const cm = today.getMonth();
        const cy = today.getFullYear();

        const filtered = data.filter(r => {
          const d = new Date(r.Date);
          return d.getMonth() === cm && d.getFullYear() === cy;
        });

        const totals = {};
        filtered.forEach(r => {
          totals[r.Date] = (totals[r.Date] || 0) + (+r.Images || 0);
        });

        const dates = Object.keys(totals).sort((a, b) => new Date(a) - new Date(b));
        const counts = dates.map(d => totals[d]);

        const ctx = document.getElementById('dailyChart').getContext('2d');
        new Chart(ctx, {
          type: 'bar',
          data: {
            labels: dates,
            datasets: [{
              label: 'Images',
              data: counts,
              backgroundColor: '#42a5f5'
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              datalabels: {
                anchor: 'end',
                align: 'start',
                color: '#000',
                font: { weight: 'bold' },
                formatter: val => val
              }
            },
            scales: {
              x: {
                title: { display: true, text: 'log_date' },
                ticks: { maxRotation: 45, minRotation: 45 }
              },
              y: {
                beginAtZero: true
              }
            }
          },
          plugins: [ChartDataLabels]
        });

        const summary = dates.map(d => ({ Date: d, 'Total Images': totals[d].toString() }));
        renderTable('daily-summary-table', summary);
      }
    });
  </script>
</body>
</html>
