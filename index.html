<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Spyne Outsource Dashboard</title>
  <link rel="icon" href="https://spyne-prod-ai.s3.us-east-1.amazonaws.com/ai-dataset/2025/favicon.ico" type="image/x-icon">
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #f4f7fa; margin: 0; padding: 20px; }
    .section { background: #fff; border: 1px solid #ccc; border-radius: 4px; padding: 15px; margin-bottom: 20px; }
    h2 { text-align: center; margin-top: 0; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 15px; }
    th, td { padding: 8px; border: 1px solid #ddd; text-align: center; }
    th { background: #eee; }
    .chart-container { position: relative; width: 100%; height: 66vh; }
  </style>
</head>
<body>

  <div class="section"><h2>Spyne Outsource</h2></div>

  <div class="section">
    <h2>Daily Count Desc Bar (Current Month)</h2>
    <div class="chart-container">
      <canvas id="dailyChart"></canvas>
    </div>
    <div id="daily-summary-table"></div>
  </div>

  <div class="section">
    <h2>Active User</h2>
    <div id="live-user"></div>
  </div>

  <div class="section">
    <h2>User Data Date‑wise (Editor = Email, Images = Total)</h2>
    <div id="user-data"></div>
  </div>

  <script>
    const dailyDataURL = 'https://docs.google.com/spreadsheets/d/e/…gid=585003148…output=csv';
    const liveUserURL = 'https://docs.google.com/spreadsheets/d/e/…gid=1885524675…output=csv';

    function renderTable(elId, data) {
      const cols = Object.keys(data[0]);
      const header = `<thead><tr>${cols.map(c => `<th>${c}</th>`).join('')}</tr></thead>`;
      const body = `<tbody>${data.map(row => `<tr>${cols.map(c => `<td>${row[c]}</td>`).join('')}</tr>`).join('')}</tbody>`;
      document.getElementById(elId).innerHTML = `<table>${header}${body}</table>`;
    }

    Papa.parse(liveUserURL, {
      download: true, header: true, skipEmptyLines: true,
      complete: res => {
        if (res.data.length) renderTable('live-user', res.data);
      }
    });

    Papa.parse(dailyDataURL, {
      download: true, header: true, skipEmptyLines: true,
      complete: ({ data: raw }) => {
        const today = new Date(), cm = today.getMonth(), cy = today.getFullYear();

        // Filter current month/year
        const filtered = raw.filter(r => {
          const dt = new Date(r.Date);
          return dt.getMonth() === cm && dt.getFullYear() === cy;
        });

        // Group totals by date
        const totals = {};
        filtered.forEach(r => totals[r.Date] = (totals[r.Date] || 0) + (+r.Images || 0));

        // Sort date strings descending
        const dates = Object.keys(totals).sort((a, b) => new Date(b) - new Date(a)); 
        const counts = dates.map(d => totals[d]);

        // Bar Chart
        const ctx = document.getElementById('dailyChart').getContext('2d');
        new Chart(ctx, {
          type: 'bar',
          data: { labels: dates, datasets: [{ data: counts, backgroundColor: '#4caf50' }] },
          options: {
            responsive: true, maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              datalabels: {
                anchor: 'end', align: 'start', color: '#000',
                font: { weight: 'bold' }, formatter: v => v
              }
            },
            scales: {
              x: { ticks: { autoSkip: false, maxRotation: 45, minRotation: 45 } },
              y: { beginAtZero: true }
            }
          },
          plugins: [ChartDataLabels]
        });

        // Summary Table in Desc Order
        const rows = dates.map(d => ({ Date: d, 'Total Images': totals[d].toString() }));
        renderTable('daily-summary-table', rows);

        // Pivot table
        const emails = [...new Set(filtered.map(r => r.Editor))];
        const emailTotals = {};
        emails.forEach(e => {
          emailTotals[e] = filtered.filter(r => r.Editor === e)
                                   .reduce((s, r) => s + (+r.Images || 0), 0);
        });

        const headerHTML = `<th>Email</th><th>Images</th>${dates.map(d => `<th>${d}</th>`).join('')}`;
        const bodyHTML = emails.map(e => {
          return `<tr><td>${e}</td><td>${emailTotals[e]}</td>` +
            dates.map(d => {
              const rec = filtered.find(r => r.Editor === e && r.Date === d);
              return `<td>${rec ? rec.Images : 0}</td>`;
            }).join('') + `</tr>`;
        }).join('');

        document.getElementById('user-data').innerHTML =
          `<table><thead><tr>${headerHTML}</tr></thead><tbody>${bodyHTML}</tbody></table>`;
      }
    });
  </script>
</body>
</html>
