// Adjusted total column placement and fixed aggregation per editor
const emails = [...new Set(filtered.map(r => r.Editor))];
const dateHeaders = [...new Set(filtered.map(r => r.Date))].sort((a, b) => new Date(b) - new Date(a));

const groupedByEditor = {};
filtered.forEach(r => {
  const email = r.Editor;
  const date = r.Date;
  const images = +r.Images || 0;
  if (!groupedByEditor[email]) groupedByEditor[email] = {};
  groupedByEditor[email][date] = (groupedByEditor[email][date] || 0) + images;
});

const pivotData = emails.map(email => {
  const row = { Editor: email };
  let total = 0;
  dateHeaders.forEach(date => {
    const val = groupedByEditor[email]?.[date] || 0;
    row[date] = val ? val : '';
    total += val;
  });
  row.Total = total;
  return row;
});

const headerRow = ['Editor', 'Total', ...dateHeaders];
let tableHtml = `<table id=\"pivotTable\"><thead><tr>${headerRow.map(h => `<th>${h}</th>`).join('')}</tr></thead><tbody>`;
pivotData.forEach(row => {
  tableHtml += `<tr>${headerRow.map(h => `<td>${row[h] || ''}</td>`).join('')}</tr>`;
});
tableHtml += '</tbody></table>';
document.getElementById('user-data').innerHTML = tableHtml;

const totalImages = pivotData.reduce((sum, row) => sum + row.Total, 0);
document.getElementById('user-data-total').innerText = `Total Images This Month (All Users): ${totalImages.toLocaleString()}`;

$(document).ready(function() {
  $('#pivotTable').DataTable({
    paging: false,
    info: false,
    searching: false,
    order: [[1, 'desc']]
  });
});
