<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/datatables.net-dt/css/jquery.dataTables.min.css">
<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/datatables.net/js/jquery.dataTables.min.js"></script>

<script>
// Extended Pivot Table with Total Column and Sortable
Papa.parse(dailyDataURL, {
  download: true, header: true, skipEmptyLines: true,
  complete: ({ data }) => {
    const today = new Date();
    const cm = today.getMonth();
    const cy = today.getFullYear();

    const filtered = data.filter(r => {
      const d = new Date(r.Date);
      return d.getMonth() === cm && d.getFullYear() === cy;
    });

    const totals = {};
    let grandTotal = 0;
    filtered.forEach(r => {
      const count = +r.Images || 0;
      totals[r.Date] = (totals[r.Date] || 0) + count;
      grandTotal += count;
    });
    document.getElementById('total-count').innerText = `Total Images This Month: ${grandTotal}`;

    const dateHeaders = [...new Set(filtered.map(r => r.Date))].sort((a, b) => new Date(b) - new Date(a));
    const emails = [...new Set(filtered.map(r => r.Editor))];

    const pivotData = emails.map(email => {
      let total = 0;
      const row = { Editor: email };
      dateHeaders.forEach(date => {
        const rec = filtered.find(r => r.Editor === email && r.Date === date);
        const val = rec ? +rec.Images : 0;
        row[date] = val || '';
        total += val;
      });
      row.Total = total;
      return row;
    });

    const headerRow = ['Editor', ...dateHeaders, 'Total'];
    let tableHtml = `<table id="pivotTable"><thead><tr>${headerRow.map(h => `<th>${h}</th>`).join('')}</tr></thead><tbody>`;
    pivotData.forEach(row => {
      tableHtml += `<tr>${headerRow.map(h => `<td>${row[h] || ''}</td>`).join('')}</tr>`;
    });
    tableHtml += '</tbody></table>';
    document.getElementById('user-data').innerHTML = tableHtml;

    $(document).ready(function() {
      $('#pivotTable').DataTable({
        paging: false,
        info: false,
        searching: false,
        order: [[headerRow.length - 1, 'desc']] // Sort by Total column
      });
    });
  }
});
</script>
